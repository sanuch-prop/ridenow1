(()=>{const d=document,w=window,$=(s,r=d)=>r.querySelector(s),$$=(s,r=d)=>Array.from(r.querySelectorAll(s));const store={g:(k,f=null)=>{try{const v=localStorage.getItem(k);return v?JSON.parse(v):f}catch(e){console.warn('storage read',e);return f}},s:(k,v)=>{try{if(v===undefined||v===null)localStorage.removeItem(k);else localStorage.setItem(k,JSON.stringify(v))}catch(e){console.warn('storage write',e)}},r:k=>{try{localStorage.removeItem(k)}catch(e){console.warn('storage remove',e)}}};const RN={keys:{profile:'ridenow_profile',lastRole:'ridenow_last_role',bookingDraft:'rn:booking:draft',bookingActive:'rn:booking:active',bookingHistory:'rn:booking:history',voucher:'rn:svcfee:voucher',paidMap:'rn:svcfee:paid',notifications:'rn:notifications',supportThreads:'rn:support:threads',wallet:'rn:wallet',settings:'rn:settings'},get:store.g,set:store.s,remove:store.r,fmtMoney:v=>`${Number(v||0).toLocaleString('ru-RU')} ₴`,isPaid:id=>{if(!id)return false;const map=store.g(RN.keys.paidMap,{});return !!(map&&map[id])},markPaid:(id,mode='card')=>{if(!id)return;const map=store.g(RN.keys.paidMap,{});map[id]=mode==='voucher'?'voucher':'1';store.s(RN.keys.paidMap,map)},clearPaid:id=>{const map=store.g(RN.keys.paidMap,{});if(map&&id in map){delete map[id];store.s(RN.keys.paidMap,map)}}};w.RN=RN;const state={profile:RN.get(RN.keys.profile)||null,role:localStorage.getItem(RN.keys.lastRole)||'passenger'};let toastEl=null,toastTimer=null;const showToast=(msg,dur=2200)=>{if(!toastEl){toastEl=d.createElement('div');toastEl.className='toast';d.body.appendChild(toastEl)}toastEl.textContent=msg;toastEl.classList.add('is-visible');if(toastTimer)clearTimeout(toastTimer);toastTimer=setTimeout(()=>toastEl.classList.remove('is-visible'),dur)};const firstName=p=>{if(!p)return'Пассажир';if(p.firstName)return p.firstName;if(!p.fullName)return'Пассажир';const parts=p.fullName.trim().split(/\s+/);return parts[0]||'Пассажир'};const normName=full=>{const cleaned=(full||'').trim().replace(/\s+/g,' ');if(!cleaned)return null;const parts=cleaned.split(' ');return{fullName:cleaned,firstName:parts[0],lastName:parts.length>1?parts.slice(1).join(' '):''}};const setRole=role=>{state.role=role;localStorage.setItem(RN.keys.lastRole,role);$$('.role-tabs').forEach(t=>$$('.role-btn',t).forEach(btn=>btn.classList.toggle('is-active',btn.dataset.role===role)))};const initRoleTabs=()=>{$$('.role-tabs').forEach(t=>$$('.role-btn',t).forEach(btn=>btn.addEventListener('click',()=>setRole(btn.dataset.role||'passenger'))));setRole(state.role)};const fillProfile=()=>{const profile=state.profile||RN.get(RN.keys.profile);$$('[data-profile-photo]').forEach(el=>{const photo=profile?.profilePhoto;if(photo){if(el.tagName==='IMG')el.src=photo;else{el.style.backgroundImage=`url(${photo})`;el.classList.add('has-photo')}}});$$('[data-profile]').forEach(el=>{const key=el.dataset.profile;let value=null;if(profile){switch(key){case'firstName':value=firstName(profile);break;case'fullName':value=profile.fullName;break;case'city':value=profile.city;break;case'phone':value=profile.phone;break;case'email':value=profile.email;break;case'gender':value={male:'Мужчина',female:'Женщина'}[profile.gender]||'—';break;case'createdAt':value=profile.createdAt?new Date(profile.createdAt).toLocaleDateString('ru-RU'):null;break;default:value=profile[key];}}if(!value)value=el.dataset.fallback||'—';el.textContent=value})};const attachPhoto=input=>{const previewId=input.dataset.preview;const preview=previewId?d.querySelector(previewId):input.closest('[data-photo]');input.addEventListener('change',()=>{const file=input.files&&input.files[0];if(!file)return;if(!file.type.startsWith('image/')){showToast('Выберите файл изображения');input.value='';return}const reader=new FileReader();reader.onload=()=>{if(preview){if(preview.tagName==='IMG')preview.src=reader.result;else{preview.style.backgroundImage=`url(${reader.result})`;preview.classList.add('has-photo')}}input.dataset.value=reader.result};reader.readAsDataURL(file)})};const initPhotoInputs=()=>$('[data-photo-input]')?$$('[data-photo-input]').forEach(attachPhoto):null;const initGenderGroups=()=>$('[data-gender-group]')?$$('[data-gender-group]').forEach(group=>{$$('.gender-btn',group).forEach(btn=>btn.addEventListener('click',()=>{const hidden=$('input[type="hidden"]',group)||group.querySelector('input[name="gender"]');$$('.gender-btn',group).forEach(b=>b.classList.toggle('is-active',b===btn));if(hidden)hidden.value=btn.dataset.gender;}));}):null;let dateSheet=null,dateInput=null;const ensureDateSheet=()=>{if(dateSheet)return dateSheet;const sheet=d.createElement('div');sheet.className='sheet';sheet.innerHTML="<div class='sheet__card'><div class='sheet__grip'></div><div class='stack stack--tight'><div style='text-align:center;font-weight:750'>Выберите дату</div><div class='grid grid--2'><select data-day></select><select data-month></select><select data-year></select></div><div class='sheet__actions'><button class='btn btn-secondary btn--sm' data-cancel>Отмена</button><button class='btn btn-primary btn--sm' data-ok>Готово</button></div></div></div>";d.body.appendChild(sheet);sheet.addEventListener('click',e=>{if(e.target===sheet)closeDateSheet()});$('[data-cancel]',sheet)?.addEventListener('click',closeDateSheet);$('[data-ok]',sheet)?.addEventListener('click',confirmDateSheet);const yearSel=$('[data-year]',sheet),monthSel=$('[data-month]',sheet),daySel=$('[data-day]',sheet);const now=new Date(),pad=n=>(n<10?'0'+n:''+n);for(let y=now.getFullYear();y>=now.getFullYear()-85;y--){const o=d.createElement('option');o.value=''+y;o.textContent=''+y;yearSel.appendChild(o)}for(let m=1;m<=12;m++){const o=d.createElement('option');o.value=pad(m);o.textContent=pad(m);monthSel.appendChild(o)}const fillDays=()=>{const y=Number(yearSel.value||now.getFullYear()),m=Number(monthSel.value||1),days=new Date(y,m,0).getDate();daySel.innerHTML='';for(let day=1;day<=days;day++){const o=d.createElement('option');o.value=pad(day);o.textContent=pad(day);daySel.appendChild(o)}};yearSel.addEventListener('change',fillDays);monthSel.addEventListener('change',fillDays);fillDays();dateSheet=sheet;return sheet};const openDateSheet=input=>{const sheet=ensureDateSheet();dateInput=input;const [day='01',month='01',year='1990']=(input.value||'').split('.');$('[data-year]',sheet).value=year;$('[data-month]',sheet).value=month;$('[data-year]',sheet).dispatchEvent(new Event('change'));$('[data-day]',sheet).value=day;sheet.classList.add('is-open')};const closeDateSheet=()=>{if(dateSheet)dateSheet.classList.remove('is-open');dateInput=null};const confirmDateSheet=()=>{if(!dateInput||!dateSheet)return;const year=$('[data-year]',dateSheet).value,month=$('[data-month]',dateSheet).value,day=$('[data-day]',dateSheet).value;dateInput.value=`${day}.${month}.${year}`;dateInput.dataset.iso=`${year}-${month}-${day}`;closeDateSheet()};const initDateInputs=()=>$('input[data-date-picker]')?$$('input[data-date-picker]').forEach(inp=>{inp.setAttribute('readonly','readonly');inp.addEventListener('click',()=>openDateSheet(inp));inp.addEventListener('focus',e=>{e.preventDefault();inp.blur();openDateSheet(inp);});}):null;(()=>{const d=document,w=window,$=(s,r=d)=>r.querySelector(s),$$=(s,r=d)=>Array.from(r.querySelectorAll(s));
const store={g:(k,f=null)=>{try{const v=localStorage.getItem(k);return v?JSON.parse(v):f}catch(e){console.warn('storage read',e);return f}},s:(k,v)=>{try{if(v===undefined||v===null)localStorage.removeItem(k);else localStorage.setItem(k,JSON.stringify(v))}catch(e){console.warn('storage write',e)}},r:k=>{try{localStorage.removeItem(k)}catch(e){console.warn('storage remove',e)}}};
const RN={keys:{profile:'ridenow_profile',lastRole:'ridenow_last_role',bookingDraft:'rn:booking:draft',bookingActive:'rn:booking:active',bookingHistory:'rn:booking:history',voucher:'rn:svcfee:voucher',paidMap:'rn:svcfee:paid',notifications:'rn:notifications',supportThreads:'rn:support:threads',wallet:'rn:wallet',settings:'rn:settings'},get:store.g,set:store.s,remove:store.r,fmtMoney:v=>`${Number(v||0).toLocaleString('ru-RU')} ₴`,isPaid:id=>{if(!id)return false;const map=store.g(RN.keys.paidMap,{});return !!(map&&map[id])},markPaid:(id,mode='card')=>{if(!id)return;const map=store.g(RN.keys.paidMap,{});map[id]=mode==='voucher'?'voucher':'1';store.s(RN.keys.paidMap,map)},clearPaid:id=>{const map=store.g(RN.keys.paidMap,{});if(map&&id in map){delete map[id];store.s(RN.keys.paidMap,map)}}};
w.RN=RN;
const state={profile:RN.get(RN.keys.profile)||null,role:localStorage.getItem(RN.keys.lastRole)||'passenger'};
let toastEl=null,toastTimer=null;
const showToast=(msg,dur=2200)=>{if(!toastEl){toastEl=d.createElement('div');toastEl.className='toast';d.body.appendChild(toastEl)}toastEl.textContent=msg;toastEl.classList.add('is-visible');if(toastTimer)clearTimeout(toastTimer);toastTimer=setTimeout(()=>toastEl.classList.remove('is-visible'),dur)};
const firstName=p=>{if(!p)return'Пассажир';if(p.firstName)return p.firstName;if(!p.fullName)return'Пассажир';const parts=p.fullName.trim().split(/\s+/);return parts[0]||'Пассажир'};
const normName=full=>{const cleaned=(full||'').trim().replace(/\s+/g,' ');if(!cleaned)return null;const parts=cleaned.split(' ');return{fullName:cleaned,firstName:parts[0],lastName:parts.length>1?parts.slice(1).join(' '):''}};
const setRole=role=>{state.role=role;localStorage.setItem(RN.keys.lastRole,role);$$('.role-tabs').forEach(t=>$$('.role-btn',t).forEach(btn=>btn.classList.toggle('is-active',btn.dataset.role===role)))};
const initRoleTabs=()=>{$$('.role-tabs').forEach(t=>$$('.role-btn',t).forEach(btn=>btn.addEventListener('click',()=>setRole(btn.dataset.role||'passenger'))));setRole(state.role)};
const fillProfile=()=>{const profile=state.profile||RN.get(RN.keys.profile);$$('[data-profile-photo]').forEach(el=>{const photo=profile?.profilePhoto;if(photo){if(el.tagName==='IMG')el.src=photo;else{el.style.backgroundImage=`url(${photo})`;el.classList.add('has-photo')}}});$$('[data-profile]').forEach(el=>{const key=el.dataset.profile;let value=null;if(profile){switch(key){case'firstName':value=firstName(profile);break;case'fullName':value=profile.fullName;break;case'city':value=profile.city;break;case'phone':value=profile.phone;break;case'email':value=profile.email;break;case'gender':value={male:'Мужчина',female:'Женщина'}[profile.gender]||'—';break;case'createdAt':value=profile.createdAt?new Date(profile.createdAt).toLocaleDateString('ru-RU'):null;break;default:value=profile[key];}}if(!value)value=el.dataset.fallback||'—';el.textContent=value})};
const attachPhoto=input=>{const previewId=input.dataset.preview;const preview=previewId?d.querySelector(previewId):input.closest('[data-photo]');input.addEventListener('change',()=>{const file=input.files&&input.files[0];if(!file)return;if(!file.type.startsWith('image/')){showToast('Выберите файл изображения');input.value='';return}const reader=new FileReader();reader.onload=()=>{if(preview){if(preview.tagName==='IMG')preview.src=reader.result;else{preview.style.backgroundImage=`url(${reader.result})`;preview.classList.add('has-photo')}}input.dataset.value=reader.result};reader.readAsDataURL(file)})};
const initPhotoInputs=()=>{$('[data-photo-input]')&&$$('[data-photo-input]').forEach(attachPhoto)};
const initGenderGroups=()=>{$('[data-gender-group]')&&$$('[data-gender-group]').forEach(group=>{$$('.gender-btn',group).forEach(btn=>btn.addEventListener('click',()=>{const hidden=$('input[type="hidden"]',group)||group.querySelector('input[name="gender"]');$$('.gender-btn',group).forEach(b=>b.classList.toggle('is-active',b===btn));if(hidden)hidden.value=btn.dataset.gender}))})};
let dateSheet=null,dateInput=null;
const ensureDateSheet=()=>{if(dateSheet)return dateSheet;const sheet=d.createElement('div');sheet.className='sheet';sheet.innerHTML="<div class='sheet__card'><div class='sheet__grip'></div><div class='stack stack--tight'><div style='text-align:center;font-weight:750'>Выберите дату</div><div class='grid grid--2'><select data-day></select><select data-month></select><select data-year></select></div><div class='sheet__actions'><button class='btn btn-secondary btn--sm' data-cancel>Отмена</button><button class='btn btn-primary btn--sm' data-ok>Готово</button></div></div></div>";d.body.appendChild(sheet);sheet.addEventListener('click',e=>{if(e.target===sheet)closeDateSheet()});$('[data-cancel]',sheet)?.addEventListener('click',closeDateSheet);$('[data-ok]',sheet)?.addEventListener('click',confirmDateSheet);const yearSel=$('[data-year]',sheet),monthSel=$('[data-month]',sheet),daySel=$('[data-day]',sheet);const now=new Date(),pad=n=>(n<10?'0'+n:''+n);for(let y=now.getFullYear();y>=now.getFullYear()-85;y--){const o=d.createElement('option');o.value=''+y;o.textContent=''+y;yearSel.appendChild(o)}for(let m=1;m<=12;m++){const o=d.createElement('option');o.value=pad(m);o.textContent=pad(m);monthSel.appendChild(o)}const fillDays=()=>{const y=Number(yearSel.value||now.getFullYear()),m=Number(monthSel.value||1),days=new Date(y,m,0).getDate();daySel.innerHTML='';for(let day=1;day<=days;day++){const o=d.createElement('option');o.value=pad(day);o.textContent=pad(day);daySel.appendChild(o)}};yearSel.addEventListener('change',fillDays);monthSel.addEventListener('change',fillDays);fillDays();dateSheet=sheet;return sheet};
const openDateSheet=input=>{const sheet=ensureDateSheet();dateInput=input;const [day='01',month='01',year='1990']=(input.value||'').split('.');$('[data-year]',sheet).value=year;$('[data-month]',sheet).value=month;$('[data-year]',sheet).dispatchEvent(new Event('change'));$('[data-day]',sheet).value=day;sheet.classList.add('is-open')};
const closeDateSheet=()=>{if(dateSheet)dateSheet.classList.remove('is-open');dateInput=null};
const confirmDateSheet=()=>{if(!dateInput||!dateSheet)return;const year=$('[data-year]',dateSheet).value,month=$('[data-month]',dateSheet).value,day=$('[data-day]',dateSheet).value;dateInput.value=`${day}.${month}.${year}`;dateInput.dataset.iso=`${year}-${month}-${day}`;closeDateSheet()};
const initDateInputs=()=>{$('input[data-date-picker]')&&$$('input[data-date-picker]').forEach(inp=>{inp.setAttribute('readonly','readonly');inp.addEventListener('click',()=>openDateSheet(inp));inp.addEventListener('focus',e=>{e.preventDefault();inp.blur();openDateSheet(inp);});})};

const ensureVoucher=()=>{const voucher=RN.get(RN.keys.voucher);if(!voucher)RN.set(RN.keys.voucher,{amount:25,used:false,lockedForTripId:null,description:'Сервисный бонус',updatedAt:Date.now()})};
const ensureWallet=()=>{const wallet=RN.get(RN.keys.wallet);if(!wallet)RN.set(RN.keys.wallet,{balance:240,history:[{id:'w1',type:'topup',amount:200,title:'Пополнение картой',createdAt:Date.now()-864e5},{id:'w2',type:'bonus',amount:40,title:'Кэшбек за поездку',createdAt:Date.now()-1728e5}]})};
const ensureHistory=()=>{const history=RN.get(RN.keys.bookingHistory);if(!history||!history.length)RN.set(RN.keys.bookingHistory,[{id:'hist-kyiv-lviv',from:'Киев',to:'Львов',date:'2025-08-22',dateText:'22.08.2025',startTime:'07:20',endTime:'12:50',price:620,seats:1,driver:{name:'Олег',rating:4.8,car:'VW Touran • AH7788КК',photo:'https://images.unsplash.com/photo-1544005313-94ddf0286df2?w=300'},status:'finished',orderId:'RN-2025-0822-001',review:{rating:5,text:'Чистая машина, комфортная поездка.'}},{id:'hist-dnipro-kyiv',from:'Днепр',to:'Киев',date:'2025-07-12',dateText:'12.07.2025',startTime:'09:10',endTime:'13:45',price:540,seats:1,driver:{name:'Юлия',rating:4.9,car:'Hyundai Tucson • AE3321ІН',photo:'https://images.unsplash.com/photo-1524504388940-b1c1722653e1?w=300'},status:'finished',orderId:'RN-2025-0712-009'}])};
const ensureNotifications=()=>{const list=RN.get(RN.keys.notifications);if(!list)RN.set(RN.keys.notifications,[{id:'n1',title:'Водитель подтвердил поездку',body:'Павел подтвердил вашу бронь Киев → Одесса',createdAt:Date.now()-36e5},{id:'n2',title:'Бонус 25 ₴ активирован',body:'Используйте бонус при следующем бронировании',createdAt:Date.now()-864e5}])};
const ensureSupport=()=>{const threads=RN.get(RN.keys.supportThreads);if(!threads)RN.set(RN.keys.supportThreads,[{id:'s1',subject:'Уточнение по багажу',status:'resolved',updatedAt:Date.now()-72e5,messages:[{from:'user',text:'Можно ли взять чемодан 20кг?',createdAt:Date.now()-82e5},{from:'support',text:'Да, подтвердили с водителем.',createdAt:Date.now()-78e5}]}])};
const ensureSettings=()=>{const settings=RN.get(RN.keys.settings);if(!settings)RN.set(RN.keys.settings,{push:true,email:true,marketing:false,biometric:true})};
const ensureDemoData=()=>{ensureVoucher();ensureWallet();ensureHistory();ensureNotifications();ensureSupport();ensureSettings()};
const Booking={draft:()=>RN.get(RN.keys.bookingDraft),setDraft:data=>RN.set(RN.keys.bookingDraft,data),clearDraft:()=>RN.remove(RN.keys.bookingDraft),active:()=>RN.get(RN.keys.bookingActive),setActive:data=>RN.set(RN.keys.bookingActive,data),updateActive:patch=>{const cur=Booking.active()||{};Booking.setActive({...cur,...patch})},history:()=>RN.get(RN.keys.bookingHistory,[]),pushHistory:item=>{const list=Booking.history();list.unshift(item);RN.set(RN.keys.bookingHistory,list)}};
const statusLabel=status=>({pending:'Ожидает подтверждения',confirmed:'Подтверждена',boarding:'Посадка',ongoing:'В пути',finished:'Завершена',cancelled:'Отменена'}[status]||'—');
const paymentLabel=trip=>{if(!trip)return'—';if(trip.paid)return trip.voucherUsed?'Оплачено бонусом':'Оплачено';return trip.fee&&trip.fee>0?'Ожидает оплату':'Без комиссии'};
const routeLabel=trip=>trip?`${trip.from||'—'} → ${trip.to||'—'}`:'—';
const applyTripFields=(root,trip)=>{if(!root||!trip)return;$$('[data-trip-field]',root).forEach(el=>{const key=el.dataset.tripField;let value='';switch(key){case'route':value=routeLabel(trip);break;case'from':value=trip.from;break;case'to':value=trip.to;break;case'date':case'dateText':value=trip.dateText||(trip.date?new Date(trip.date).toLocaleDateString('ru-RU'):'—');break;case'timeRange':value=trip.startTime&&trip.endTime?`${trip.startTime} → ${trip.endTime}`:'—';break;case'priceText':value=RN.fmtMoney(trip.price||0);break;case'feeText':value=trip.fee&&trip.fee>0?`${trip.fee} ₴`:'0 ₴ — покрыто бонусом';break;case'seats':value=`${trip.seats||1} мест`;break;case'statusLabel':value=statusLabel(trip.status);break;case'paymentStatus':value=paymentLabel(trip);break;case'orderId':value=trip.orderId||`RN-${new Date().toISOString().slice(0,10).replace(/-/g,'')}`;break;case'boardingCode':value=trip.boarding?.code||'—';break;case'driverName':value=trip.driver?.name||'—';break;case'driverRating':value=trip.driver?.rating?`${trip.driver.rating.toFixed(1)} ★`:'—';break;case'driverCar':value=trip.driver?.car||'—';break;case'distance':value=trip.distance||'—';break;case'duration':value=trip.duration||'—';break;default:value=trip[key]||'—';}if(!value)value=el.dataset.fallback||'—';el.textContent=value})};
const fillDriverCard=(root,trip)=>{if(!root||!trip?.driver)return;$('[data-driver-name]',root)?.textContent=trip.driver.name||'—';$('[data-driver-rating]',root)?.textContent=trip.driver.rating?`${trip.driver.rating.toFixed(1)} ★`:'—';$('[data-driver-car]',root)?.textContent=trip.driver.car||'—';const avatar=$('[data-driver-photo]',root);if(avatar&&trip.driver.photo){if(avatar.tagName==='IMG')avatar.src=trip.driver.photo;else avatar.style.backgroundImage=`url(${trip.driver.photo})`}};
const renderList=(container,items,template)=>{if(!container)return;container.innerHTML='';if(!items||!items.length){const empty=d.createElement('div');empty.className='notice-banner';empty.innerHTML="<div class='notice-banner__title'>Нет данных</div><div>Здесь появится история после поездок.</div>";container.appendChild(empty);return;}items.forEach(item=>container.appendChild(template(item)))};
const tripTile=(trip,{compact=false}={})=>{const article=d.createElement('article');article.className='tile tile--clickable';article.dataset.tripId=trip.id||'';article.innerHTML=`<div class="tile__row"><h3 class="tile__title">${routeLabel(trip)}</h3><span class="badge ${trip.status==='finished'?'badge--ok':'badge--wait'}">${statusLabel(trip.status)}</span></div><p class="tile__meta">${trip.dateText||''}${trip.startTime?' • '+trip.startTime:''}</p><div class="status-row"><span>Цена: <strong>${RN.fmtMoney(trip.price||0)}</strong></span><span>Оплата: <strong>${paymentLabel(trip)}</strong></span></div>`;if(!compact){const footer=d.createElement('div');footer.className='tile__footer';footer.innerHTML=`<span class="badge badge--ghost">Код: ${trip.orderId||'—'}</span><a class="btn btn-secondary btn--sm" data-open-trip="${trip.id||''}" href="passenger-order-details.html">Подробнее</a>`;article.appendChild(footer);}return article};
const renderHistory=(container,count=3)=>{const history=Booking.history();renderList(container,history.slice(0,count),trip=>tripTile(trip,{compact:true}))};
const formatTime=seconds=>{const mins=Math.floor(seconds/60);const sec=seconds%60;return `${mins.toString().padStart(2,'0')}:${sec.toString().padStart(2,'0')}`};

const initHomePage=()=>{const card=$('[data-bind="active-trip"]');const historyWrap=$('[data-history-list]');const active=Booking.active();if(card&&active){applyTripFields(card,active);fillDriverCard(card,active);}if(historyWrap)renderHistory(historyWrap,3)};
const initSearchPage=()=>{const form=$('[data-form="search"]');if(!form)return;form.addEventListener('submit',e=>{e.preventDefault();const from=form.querySelector('input[name="from"]').value.trim();const to=form.querySelector('input[name="to"]').value.trim();const date=form.querySelector('input[name="date"]');if(!from||!to){showToast('Укажите маршрут');return;}const draft={id:`${from}-${to}-${Date.now()}`.replace(/\s+/g,'').toLowerCase(),from,to,dateText:date?.value||'',date:date?.dataset.iso||null,startTime:'08:30',endTime:'13:15',price:550,fee:25,seats:1,status:'draft'};Booking.setDraft(draft);location.href='passenger-search-results.html';});};
const initSearchResultsPage=()=>{const container=$('[data-search-results]');const draft=Booking.draft();if(container&&draft){container.querySelectorAll('[data-trip-summary]').forEach(node=>applyTripFields(node,draft));}$$('[data-select-trip]').forEach(btn=>btn.addEventListener('click',()=>{const price=Number(btn.dataset.price||550);const start=btn.dataset.startTime||'08:30';const end=btn.dataset.endTime||'13:15';const seats=Number(btn.dataset.seats||1);const driver={name:btn.dataset.driverName||'Павел',rating:btn.dataset.driverRating?Number(btn.dataset.driverRating):4.9,car:btn.dataset.driverCar||'Toyota Camry • АА7788РН',photo:btn.dataset.driverPhoto||'https://images.unsplash.com/photo-1599566150163-29194dcaad36?w=300'};const trip={...(draft||{}),id:btn.dataset.tripId||draft?.id||`trip-${Date.now()}`,price,startTime:start,endTime:end,seats,driver,status:'pending',fee:25,voucherLocked:false,createdAt:Date.now()};Booking.setDraft(trip);location.href='passenger-order-details.html';}));};
const useVoucher=trip=>{const voucher=RN.get(RN.keys.voucher);if(!trip)return{trip,voucherUsed:false};const canUse=voucher&&!voucher.used&&Number(voucher.amount)>=25&&(!voucher.lockedForTripId||voucher.lockedForTripId===trip.id);if(canUse){trip.fee=0;trip.voucherUsed=true;RN.set(RN.keys.voucher,{...voucher,lockedForTripId:trip.id,updatedAt:Date.now()});return{trip,voucherUsed:true};}trip.fee=25;trip.voucherUsed=false;return{trip,voucherUsed:false}};
const consumeVoucher=id=>{const voucher=RN.get(RN.keys.voucher);if(!voucher)return;RN.set(RN.keys.voucher,{...voucher,amount:Math.max(0,Number(voucher.amount||0)-25),used:true,lockedForTripId:id||null,updatedAt:Date.now()})};
const finalizeBooking=trip=>{const prepared={...trip,status:'pending',createdAt:Date.now(),paid:trip.fee===0?true:trip.paid,boarding:{code:'RN-'+String(Math.floor(Math.random()*9000)+1000)}};Booking.setActive(prepared);Booking.clearDraft();if(prepared.voucherUsed){consumeVoucher(prepared.id);RN.markPaid(prepared.id,'voucher');}else if(prepared.fee===0){RN.markPaid(prepared.id,'1');}showToast('Бронирование создано');setTimeout(()=>location.href='passenger-boarding-waiting.html',420)};
const initOrderDetailsPage=()=>{const container=$('[data-order-details]');const draft=Booking.draft();if(!container||!draft)return;const {trip}=useVoucher(draft);Booking.setDraft(trip);applyTripFields(container,trip);fillDriverCard(container,trip);renderHistory($('[data-related-history]'),2);$('[data-action="confirm-booking"]')?.addEventListener('click',()=>{if(trip.fee&&trip.fee>0&&!trip.voucherUsed&&!RN.isPaid(trip.id)){location.href='passenger-order-progress.html';return;}finalizeBooking(trip);});$('[data-action="pay-fee"]')?.addEventListener('click',()=>location.href='passenger-order-progress.html');};
const initPaymentPage=()=>{const draft=Booking.draft();const container=$('[data-payment]');if(!draft||!container)return;applyTripFields(container,draft);$('[data-action="pay-fee"]')?.addEventListener('click',()=>{RN.markPaid(draft.id,draft.voucherUsed?'voucher':'1');draft.paid=true;Booking.setDraft(draft);if(draft.voucherUsed)consumeVoucher(draft.id);showToast('Оплата прошла');setTimeout(()=>finalizeBooking(draft),420);});$('[data-action="skip-payment"]')?.addEventListener('click',()=>finalizeBooking(draft));};
const initWaitingPage=()=>{const container=$('[data-waiting]');const trip=Booking.active();if(!container||!trip)return;applyTripFields(container,trip);fillDriverCard(container,trip);const bar=$('[data-progress-bar]');if(bar)bar.style.width='32%';const timerEl=$('[data-timeleft]');let remain=360;if(timerEl){timerEl.textContent=formatTime(remain);const timer=setInterval(()=>{remain-=1;if(remain<=0){clearInterval(timer);timerEl.textContent='00:00';return;}timerEl.textContent=formatTime(remain);},1e3);} $('[data-action="cancel-booking"]')?.addEventListener('click',()=>{Booking.pushHistory({...trip,status:'cancelled',cancelledAt:Date.now()});Booking.setActive(null);Booking.clearDraft();showToast('Бронь отменена');setTimeout(()=>location.href='passenger-search.html',400);});$('[data-action="find-alt"]')?.addEventListener('click',()=>location.href='passenger-search.html');};
const initBoardingPage=()=>{const container=$('[data-boarding]');const trip=Booking.active();if(!container||!trip)return;applyTripFields(container,trip);fillDriverCard(container,trip);$('[data-action="confirm-boarding"]')?.addEventListener('click',()=>{Booking.updateActive({status:'ongoing',boardedAt:Date.now()});showToast('Хорошей поездки!');setTimeout(()=>location.href='passenger-trip-ongoing.html',420);});$('[data-action="report-missed"]')?.addEventListener('click',()=>showToast('Мы сообщили водителю'));};
const initTripOngoingPage=()=>{const container=$('[data-trip-ongoing]');const trip=Booking.active();if(!container||!trip)return;applyTripFields(container,trip);fillDriverCard(container,trip);const bar=$('[data-progress-bar]');if(bar)bar.style.width='68%';$('[data-action="open-map"]')?.addEventListener('click',()=>{const url=`https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(trip.from||'')}&destination=${encodeURIComponent(trip.to||'')}&travelmode=driving`;w.open(url,'_blank');});$('[data-action="finish-trip"]')?.addEventListener('click',()=>{const finished={...trip,status:'finished',finishedAt:Date.now(),paid:true};Booking.pushHistory(finished);Booking.setActive(null);showToast('Поездка завершена');setTimeout(()=>location.href='passenger-trip-finish.html',420);});};
const initTripFinishPage=()=>{const trip=Booking.history()[0];const container=$('[data-trip-finish]');if(container&&trip){applyTripFields(container,trip);fillDriverCard(container,trip);}};
const initReceiptPage=()=>{const trip=Booking.history()[0]||Booking.active();const container=$('[data-receipt]');if(!container||!trip)return;applyTripFields(container,trip);$('[data-receipt-fee]')?.textContent=trip.fee&&trip.fee>0?`${trip.fee} ₴`:'0 ₴';$('[data-receipt-total]')?.textContent=RN.fmtMoney(trip.price||0);};
const initReviewPage=()=>{const form=$('[data-form="review"]');const trip=Booking.history()[0];if(!form||!trip)return;form.addEventListener('submit',e=>{e.preventDefault();const rating=Number(form.querySelector('input[name="rating"]:checked')?.value||5);const text=form.querySelector('textarea[name="text"]').value.trim();trip.review={rating,text,createdAt:Date.now()};const history=Booking.history();history[0]=trip;RN.set(RN.keys.bookingHistory,history);showToast('Отзыв отправлен');setTimeout(()=>location.href='passenger-review-success.html',420);});};
const initComplaintPage=()=>{const form=$('[data-form="complaint"]');const trip=Booking.history()[0];if(!form||!trip)return;form.addEventListener('submit',e=>{e.preventDefault();const text=form.querySelector('textarea[name="text"]').value.trim();if(!text){showToast('Опишите проблему');return;}const threads=RN.get(RN.keys.supportThreads,[]);threads.unshift({id:'s'+Date.now(),subject:'Жалоба на поездку',status:'new',updatedAt:Date.now(),messages:[{from:'user',text,createdAt:Date.now()}]});RN.set(RN.keys.supportThreads,threads);showToast('Жалоба отправлена');setTimeout(()=>location.href='passenger-complaint-success.html',420);});};

const fillCarPhotos=()=>{const profile=state.profile||RN.get(RN.keys.profile);if(!profile?.vehicle?.photos)return;Object.entries(profile.vehicle.photos).forEach(([slot,src])=>{if(!src)return;$$(`[data-car-slot="${slot}"]`).forEach(cell=>{const img=d.createElement('img');img.alt='';img.src=src;cell.innerHTML='';cell.appendChild(img);});});};
const initOrdersPage=()=>{const activeWrap=$('[data-orders-active]');const historyWrap=$('[data-orders-history]');const active=Booking.active();if(active&&activeWrap){activeWrap.innerHTML='';activeWrap.appendChild(tripTile(active));}else if(activeWrap){renderList(activeWrap,[],()=>d.createElement('div'));}if(historyWrap)renderHistory(historyWrap,6);};
const initWalletPage=()=>{const wallet=RN.get(RN.keys.wallet,{balance:0,history:[]});const voucher=RN.get(RN.keys.voucher);$('[data-wallet-balance]')?.textContent=RN.fmtMoney(wallet.balance||0);$('[data-wallet-count]')?.textContent=String(wallet.history.length||0);$('[data-voucher-amount]')?.textContent=voucher&& !voucher.used && Number(voucher.amount)>=25?'25 ₴':'Нет активного бонуса';};
const initWalletTopupPage=()=>{const form=$('[data-form="topup"]');if(!form)return;form.addEventListener('submit',e=>{e.preventDefault();const amount=Number(form.querySelector('input[name="amount"]').value||0);if(amount<=0){showToast('Введите сумму пополнения');return;}const wallet=RN.get(RN.keys.wallet,{balance:0,history:[]});wallet.balance=Number(wallet.balance||0)+amount;wallet.history.unshift({id:'w'+Date.now(),type:'topup',amount,title:'Пополнение через приложение',createdAt:Date.now()});RN.set(RN.keys.wallet,wallet);showToast('Баланс пополнен');setTimeout(()=>location.href='passenger-wallet.html',420);});};
const initWalletHistoryPage=()=>{const wallet=RN.get(RN.keys.wallet,{history:[]});const list=$('[data-wallet-history]');if(!list)return;renderList(list,wallet.history||[],item=>{const row=d.createElement('article');row.className='tile';row.innerHTML=`<div class="tile__row"><strong>${item.title||'Операция'}</strong><span>${(item.amount>0?'+':'')+RN.fmtMoney(item.amount||0)}</span></div><p class="tile__meta">${new Date(item.createdAt||Date.now()).toLocaleString('ru-RU')}</p>`;return row;});};
const initNotificationsPage=()=>{const list=$('[data-notifications]');if(!list)return;const data=RN.get(RN.keys.notifications,[]);renderList(list,data,item=>{const card=d.createElement('article');card.className='tile';card.innerHTML=`<div class="tile__row"><h3 class="tile__title">${item.title}</h3><span class="badge badge--ghost">${new Date(item.createdAt).toLocaleString('ru-RU')}</span></div><p class="tile__meta">${item.body}</p>`;return card;});};
const initSupportPage=()=>{const list=$('[data-support-list]');if(!list)return;const threads=RN.get(RN.keys.supportThreads,[]);renderList(list,threads,item=>{const row=d.createElement('article');row.className='tile tile--clickable';row.innerHTML=`<div class="tile__row"><h3 class="tile__title">${item.subject}</h3><span class="badge ${item.status==='resolved'?'badge--ok':'badge--wait'}">${item.status==='resolved'?'Решено':'В работе'}</span></div><p class="tile__meta">Обновлено: ${new Date(item.updatedAt).toLocaleString('ru-RU')}</p><div class="tile__footer"><a class="btn btn-secondary btn--sm" href="passenger-support-chat.html?id=${item.id}">Открыть</a></div>`;return row;});};
const initSupportChatPage=()=>{const params=new URLSearchParams(location.search);const id=params.get('id');const threads=RN.get(RN.keys.supportThreads,[]);const thread=threads.find(t=>t.id===id)||threads[0];const list=$('[data-chat]');if(!thread||!list)return;$('[data-support-subject]')?.textContent=thread.subject;list.innerHTML='';thread.messages.forEach(msg=>{const bubble=d.createElement('div');bubble.className='tile';bubble.innerHTML=`<div class="tile__meta">${msg.from==='support'?'Поддержка':'Вы'} • ${new Date(msg.createdAt).toLocaleString('ru-RU')}</div><div>${msg.text}</div>`;list.appendChild(bubble);});$('[data-form="chat"]')?.addEventListener('submit',e=>{e.preventDefault();const input=e.target.querySelector('textarea');const text=input.value.trim();if(!text)return;thread.messages.push({from:'user',text,createdAt:Date.now()});thread.updatedAt=Date.now();RN.set(RN.keys.supportThreads,threads);input.value='';initSupportChatPage();});};
const initSettingsPage=()=>{const settings=RN.get(RN.keys.settings,{push:true,email:true,marketing:false,biometric:true});$$('[data-setting]').forEach(box=>{const key=box.dataset.setting;const input=box.querySelector('input[type="checkbox"]');if(!input)return;input.checked=!!settings[key];input.addEventListener('change',()=>{settings[key]=input.checked;RN.set(RN.keys.settings,settings);showToast('Настройки сохранены',1200);});});};
const initProfileEditPage=()=>{const form=$('[data-form="profile-edit"]');const profile=state.profile||RN.get(RN.keys.profile)||{};if(!form)return;form.querySelector('input[name="fullName"]').value=profile.fullName||'';form.querySelector('input[name="phone"]').value=profile.phone||'';form.querySelector('input[name="city"]').value=profile.city||'';form.querySelector('input[name="email"]').value=profile.email||'';form.addEventListener('submit',e=>{e.preventDefault();const full=form.querySelector('input[name="fullName"]').value.trim();const phone=form.querySelector('input[name="phone"]').value.trim();const city=form.querySelector('input[name="city"]').value.trim();const email=form.querySelector('input[name="email"]').value.trim();if(!full||full.length<3){showToast('Введите имя и фамилию');return;}const parsed=normName(full);const updated={...profile,...parsed,phone,city,email,updatedAt:Date.now()};state.profile=updated;RN.set(RN.keys.profile,updated);fillProfile();showToast('Профиль обновлён');setTimeout(()=>location.href='passenger-profile.html',420);});};
const initProfileVerificationPage=()=>{fillProfile();fillCarPhotos();};
const initForgotPage=()=>{const form=$('[data-form="forgot"]');if(!form)return;form.addEventListener('submit',e=>{e.preventDefault();const email=form.querySelector('input[name="email"]').value.trim();if(!validateEmail(email)){showToast('Введите email');return;}showToast('Ссылка отправлена');setTimeout(()=>location.href='index.html',420);});};
const initLoginPage=()=>{const form=$('[data-form="login"]');if(!form)return;form.addEventListener('submit',e=>{e.preventDefault();const email=form.querySelector('input[name="email"]').value.trim();const pass=form.querySelector('input[name="password"]').value.trim();if(!validateEmail(email)){showToast('Проверьте email');return;}if(pass.length<4){showToast('Введите пароль');return;}showToast('Добро пожаловать');setTimeout(()=>location.href='passenger-home.html',420);});$('[data-link="register"]')?.setAttribute('href','register.html');$('[data-link="forgot"]')?.setAttribute('href','passenger-forgot.html');};
const initRegisterPage=()=>{const form=$('[data-form="register"]');if(!form)return;form.addEventListener('submit',async e=>{e.preventDefault();const full=form.querySelector('input[name="fullName"]').value.trim();const email=form.querySelector('input[name="email"]').value.trim();const phone=form.querySelector('input[name="phone"]').value.trim();const pass=form.querySelector('input[name="password"]').value;const pass2=form.querySelector('input[name="password2"]').value;const birth=form.querySelector('input[name="birth"]');const gender=form.querySelector('input[name="gender"]').value;const city=form.querySelector('input[name="city"]').value.trim();if(!full||full.length<3){showToast('Введите Фамилию и Имя');return;}if(pass!==pass2){showToast('Пароли не совпадают');return;}if(!validateEmail(email)){showToast('Проверьте email');return;}const parsed=normName(full);const profile={role:state.role||'passenger',...parsed,email,phone,city,gender,birthDisplay:birth?.value||null,birthISO:birth?.dataset.iso||null,createdAt:Date.now()};const photoInput=form.querySelector('input[data-photo-input]');if(photoInput?.dataset.value)profile.profilePhoto=photoInput.dataset.value;else showToast('Добавьте селфи (рекомендуемое)',1600);state.profile=profile;RN.set(RN.keys.profile,profile);showToast('Аккаунт создан');setTimeout(()=>location.href='passenger-home.html',420);});};
const initDock=()=>{const dock=$('.dock');if(!dock)return;const navId=d.body.dataset.nav||'';$$('[data-nav-item]',dock).forEach(item=>item.classList.toggle('is-active',item.dataset.navItem===navId));if(d.body.dataset.dock==='hidden')dock.dataset.hidden='true';};
const initLinks=()=>{$('[data-link="terms"]')?.setAttribute('href','passenger-terms.html');$('[data-link="privacy"]')?.setAttribute('href','passenger-privacy.html');$('[data-link="legal"]')?.setAttribute('href','passenger-legal.html');$('[data-link="home"]')?.setAttribute('href','passenger-home.html');};

d.addEventListener('DOMContentLoaded',()=>{ensureDemoData();fillProfile();fillCarPhotos();initRoleTabs();initPhotoInputs();initGenderGroups();initDateInputs();initDock();initLinks();const page=d.body.dataset.page||'';switch(page){case'login':initLoginPage();break;case'register':initRegisterPage();break;case'forgot':initForgotPage();break;case'passenger-home':initHomePage();break;case'passenger-search':initSearchPage();break;case'passenger-search-results':initSearchResultsPage();break;case'passenger-order-details':initOrderDetailsPage();break;case'passenger-order-progress':initPaymentPage();break;case'passenger-boarding-waiting':initWaitingPage();break;case'passenger-boarding-check':initBoardingPage();break;case'passenger-trip-ongoing':initTripOngoingPage();break;case'passenger-trip-finish':initTripFinishPage();break;case'passenger-receipt':initReceiptPage();break;case'passenger-review':initReviewPage();break;case'passenger-complaint':initComplaintPage();break;case'passenger-orders':initOrdersPage();break;case'passenger-wallet':initWalletPage();break;case'passenger-wallet-topup':initWalletTopupPage();break;case'passenger-wallet-history':initWalletHistoryPage();break;case'passenger-notifications':initNotificationsPage();break;case'passenger-support':initSupportPage();break;case'passenger-support-chat':initSupportChatPage();break;case'passenger-settings':initSettingsPage();break;case'passenger-profile-edit':initProfileEditPage();break;case'passenger-profile-verification':initProfileVerificationPage();break;case'passenger-car-photos':fillCarPhotos();break;default:break;}});
})();
